# 다중회귀분석 
```{r, cache=TRUE, include = FALSE} 
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(data.table)
library(kableExtra)
library(plotly)
library(dlookr)
dir <- 'C:/Users/JDW/Desktop/PROJECT/PRODUCEX/CRAWLING DATA/2020ver'
boylist <- readLines('C:/Users/JDW/Desktop/PROJECT/PRODUCEX/final_boylist.txt')
boylist2 <- str_sub(boylist, -2, -1)
pxdata <- readRDS(str_glue('{dir}/pxdata.rds'))
temp <- c()
total <- c()
for(i in seq(1, length(boylist2))){
    # print(i)
    temp <- pxdata %>%
        filter(str_detect(p_title, boylist2[i])) %>%
        group_by(p_ymd) %>%
        summarise(sum_mention   = n(),
                  sum_comment   = sum(p_comment_num, na.rm = T),
                  sum_count     = sum(p_count),
                  sum_recommend = sum(p_recommend)) %>%
        mutate(boy = boylist[i])

    total <- rbind(total, temp)
}
```

## 데이터 분할
&nbsp;언급량(sum_mention)을 종속변수로 하는 다중회귀모델을 생성하고, 모델이 추정하는 예측치를 바탕으로 순위 매겨보겠습니다. 여기서는 전체 데이터 중 마지막 방송이 방영된 날의 데이터를 테스트 데이터로, 그 이전의 데이터를 모델의 학습데이터로 분할해 주겠습니다.  
```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)

# train & test 
total_train <- total %>% filter(p_ymd != '2019-07-19') # 마지막날 이전 데이터
total_test <-  total %>% filter(p_ymd == '2019-07-19') # 마지막날 데이터
```

&nbsp;그런 다음 댓글, 조회수, 추천수를 독립변수로 하여 언급량을 추정하는 다중회귀모델을 생성합니다. 
```{r}
total_lm <- lm(sum_mention ~ sum_count + sum_recommend + sum_comment + boy, data = total_train)
```

## 모델 검정 
&nbsp; 생성한 회귀모델이 적절한 모델인지를 검정하는 과정이 필요로 합니다. 회귀분석이 지닌 기본적인 가정인 정규성, 선형성, 독립성, 등분산성을 검정하는 과정을 거쳐 모델이 적절한지를 파악하는 과정을 수행해 보도록 합니다. 생성한 모델을 `plot()`함수를 사용하여 잔차시각화를 진행합니다.   
```{r}
par(mfrow = c(2, 2))
total_lm %>% plot()
par(mfrow = c(1, 1))
```

### 정규성 
&nbsp;선형회귀에서는 오차항이 정규분포를 따라야합니다. 그러므로 오차에 속한 잔차 역시 정규분포를 따라야 하는 가정을 따라야 합니다. 만약 잔차들이 정규성을 따른다면 Q-Q Plot상의 점들이 45도 각도의 직선에 밀접합니다.   
```{r, message=FALSE, warning=FALSE}
library(car)
total_lm %>% qqPlot()
```

&nbsp;육안으로 보아도 정규성에 위배되는 것을 확인할 수 있습니다. 

&nbsp;한편 `shapiro.test()`함수를 사용하면 더 정확하게 정규성을 검정할 수 있습니다. 잔차를 대상으로 Shapiro test 를 진행, p값이 기각역보다 크다면 잔차가 정규성을 띈다고 해석합니다.   
```{r}
shapiro.test(total_lm$residuals)
```

### 선형성 
&nbsp;독립변수는 종속변수와의 관계에서 선형성을 띄어야 하는 가정을 충족해야 합니다. 선형성은 회귀 모델에서 모델의 통계적 유의성 검정을 통해 추측할 수 있습니다. 만약 모델이 선형성을 충족한다면 모델에 대한 p값이 유의하게 나올 것입니다. 
```{r}
total_lm %>% summary()
```

&nbsp;`car`패키지에 있는 `crPlots()` 함수를 통해 개별 독립변수에 대한 선형성을 확인할 수 있습니다. 만약 plot에서 비선형성이 관찰된다면 이는 해당 변수가 선형성을 충족하지 못한것으로 볼 수 있습니다.   
```{r}
total_lm %>% crPlots()
```

### 독립성 
&nbsp;독립성 가정은 크게 세가지를 충족하여야 합니다. 첫째 모델의 예측값과 잔차간의 독립성. 둘째 독립변수와 잔차간의 독립성. 셋째 잔차의 자기상관성. 먼저 예측값과 잔차간의 독립성은 앞서 보았던 잔차그래프중 첫번째 그래프에서 확인할 수 있습니다.   
```{r}
total_lm %>% plot(which = 1)
```

&nbsp;생성된 그래프를 보면 이상치의 영향으로 인해 정확한 판단은 어렵지만 잔차가 무작위적으로 퍼져있는것이 아닌 특정 부분에 쏠려 있는것으로 보여 집니다. 만약 잔차에 패턴이 보인다면 이는 곧 모델이 패턴에 해당하는 규칙성을 누락했단 의미로 해석될 수 있으며 모델에 추가해야할 요소가 남아있음을 의미합니다.   

&nbsp;독립변수와 잔차간의 독립성은 상관계수 및 분포도로 판단할 수 있습니다. 모델에서 사용된 독립변인과 잔차를 묶어 `GGally::ggpairs()` 함수를 통해 확인해 보도록 하겠습니다.   
```{r, message=FALSE, warning=FALSE}
total_train %>% 
    select(sum_count, sum_recommend, sum_comment) %>% 
    mutate(residual = total_lm$residuals) %>% 
    GGally::ggpairs()
```

&nbsp;생성된 그래프를 보면 가운데를 기준으로 좌하단에는 변수간 산점도, 우상단에는 상관계수가 작성되어 있는 것을 확인할 수 있습니다. 여기에서 잔차(residual)와 각 독립변수(sum_count, sum_comment, sum_recommend)들 간의 상관계수는 0에 상회하는 것으로 거의 독립적인 것을 확인 할 수 있습니다. 그러나 각 독립변수들 간에 상관성이 높게 띄는것으로 보아 다중공선성이 크게 의심스러운 상황입니다.    

&nbsp;마지막으로 잔차의 자기상관성은  `car` 패키지에 있는 `durbinWatsonTest()` 함수를 통해 진행할 수 있습니다. 더빈왓슨 테스트의 검정통계량 D-W Statistic 값은 0 ~ 4의 값을 가지며 0으로 가까울 수록 (잔차의) 양의 상관관계를, 4에 가까울수록 음의 상관관계를 가집니다. 2는 독립적인 것을 의미합니다. 여기서의 p_value는 자기상관성에 대한 것인데 기각역보다 작다면 자기상관관계가 있다고 해석합니다.   

```{r}
total_lm %>% durbinWatsonTest()
```

&nbsp;더빈왓슨 테스트의 결과 잔차에는 어느정도 자기상관성이 존재하여 독립성을 충족하지 못한것으로 보입니다. 

### 등분산성 
&nbsp;잔차의 분산은 예측값과 관계없이 고루 퍼져있어야 합니다. 이는 표준화된 잔차그래프에서 확인할 수 있으며 0 수평선을 기준으로 랜덤한 형태로 분포가 되어 있는 모습이 이상적인 등분산성의 형태입니다. 
```{r}
total_lm %>% plot(which = 3)
```

&nbsp;생성된 그래프를 살펴보니 그래프의 특정 부위값에 몰려 있으며, 붉은색 추세선 역시 수평보다 위로 치우쳐져 있어 등분산성 가정에는 못미치는 것으로 판단됩니다. 등분산성 검정을 위한 통계적 검정법에는 `ncvTest()` 함수를 사용하는 방법이 있습니다.

```{r}
total_lm %>% ncvTest()
```

&nbsp;`ncvTest()`의 수행으로 나오는 p_value는 모델의 등분산성에 대한 검정 결과입니다. 여기서의 귀무가설은 모델이 등분산성을 따른다이며, 대립가설로는 등분산성을 따르지 않는것으로 보여짐 입니다. p값이 낮게 나온것으로 보아 등분산성의 검정역시 통과하지 못한것으로 보입니다. 

### 다중공선성 
&nbsp; 여러 변수들의 조합을 통해 만드는 다중회귀모델은 각 독립변수들의 독립성을 요구합니다. 만약 독립변수간에 강한 상관성이 존재한다면 이는 모델의 설명력에 왜곡을 불러올 것입니다. 다중회귀모델에서 독립변수에 대한 회귀계수는 다른 변인들이 0이라는 가정 하에 종속변수와 해당 독립변수 간의 선형성을  계산하는데 만약 독립변수끼리의 상관성이 존재한다면 상관성이 존재하는 변수들이 종속변수를 설명하는데 사용되는 분산이 중복되는 부분이 생겨 이는 곧 모델의 예측 성능 하락을 야기하고, 회귀식을 해석하는데 있어서 오류를 범하게 만드는 요인이 될 것입니다. 

&nbsp;다중공선성을 계산하는 방법으로는 `car`패키지의 `vif()`(분산팽창지수)함수를 사용하는 방법이 있습니다. 변수간의 상관성을 계산하는 vif()함수는 통계값이 일반적으로 4미만일시 문제없다고 판단하고, 10을 넘어가면 다중공선성 문제가 있다고 판단합니다.

```{r}
total_lm %>% vif()
```

&nbsp;다중공선성을 계산한 결과 연습생 변수만을 제외한 모든 변수에서 다중공선성이 존재하는것을 볼 수 있습니다. 

## 결과 
&nbsp;모델 검정 결과 다중회귀분석은 적절한 방법이 아닌것으로 판단할 수 있습니다. 선형회귀모델이 가진 가정을 검정한 결과 선형성의 조건을 제외한 나머지 정규성, 독립성, 등분상성의 조건을 충족하지 못하였으며 더 나아가 다중회귀모델에서 가지는 다중공선성의 문제역시 보유하고 있는 것을 볼 수 있었습니다. 어찌보면 당연한 것이 이번 모델링에서 사용한 변수들은 각각 게시물에 대한 조회수, 댓글수, 추천수인데 상식적으로 생각해봐도 조회수가 높은 게시물은 댓글과 추천을 많이 가질 확률이 높을 것입니다. 각 지표가 높게 나온 이유는 무엇보다 게시물의 **내용**이라는 공통된 요인이 유저들의 이목을 집중시켰을 테니까요. 그리고 무엇보다도 데이터가 가진 시계열적 요소를 배재한체 다중회귀분석을 진행한 것에 대한 문제점도 있었습니다. 시계열 데이터가 지닌 특징중에 하나인 자기상관성의 영향력도 무시하지 못할 요인인데 말이죠.   

```{r}
library(forecast)
ggAcf(total_lm$residuals)
```

&nbsp;`ggAcf()`는 ACF(Auto Correlation Function)(자기상관함수)를 계산하여 시각화한 함수로 과거 특정 시점과의 자기상관성을 계산하여 그래프로 표현하는 함수입니다. 푸른색 점선을 넘어가는 직선은 해당시점(lag)과의 상관성이 존재한다는 의미인데(시점의 자기상관성이 통계적으로 유의하다) 여기서 회귀모델의 잔차는 다수의 시점에서 자기상관성이 관측되는 것을 볼 수 있습니다. 이럴경우 일반적인 회귀모델보다 시계열분석이 더 적합할 수 있습니다.   
