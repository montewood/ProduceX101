# 데이터 전처리

```{r, include=FALSE}
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(data.table)
library(kableExtra)
dir <- 'C:/Users/JDW/Desktop/PROJECT/PRODUCEX/CRAWLING DATA/2020ver'
```

&nbsp;이번 파트는 데이터 전처리 과정을 다룹니다.   

&nbsp;스크래핑한 데이터들은 사용하기 위해서는 적합한 형태로 변환을 해야 하는 과정이 필요합니다.   

&nbsp;파일들을 R로 불러들이겠습니다. 

## 데이터 취합

```{r producex3_1, message=FALSE, cache=TRUE}
# 사용 패키지 호출 ----
library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(data.table)

# for문을 활용한 데이터 불러오기 및 취합 ----
filelist <- list.files(dir) # dir : "저장된 데이터의 폴더 경로"
pxdata <- data.frame()
temp <- NULL

for(file in filelist){
    if(str_sub(file, -3, -1) == 'rds'){
        temp <- readRDS(paste(dir, file, sep = '/'))
        temp <- temp %>% select(p_title,       # 제목 
                                p_comment_num, # 댓글 수  
                                p_time,        # 글 작성 시간 
                                p_count,       # 조회수 
                                p_recommend)   # 추천수
        pxdata <- rbind(pxdata, temp)
        
        rm(temp)
    }else{
        next
    }
}
```

&nbsp;일간별로 수집했던 데이터들을 불러와 `pxdata`라는 데이터프레임에 취합 하였습니다. 이를 활용하여 분석을 진행할 예정입니다.   

## Feature Engineering

&nbsp;데이터 수집 과정을 통해 `p_title`, `p_time`, `p_count`, `p_recommend` 의 변수를 생성하였습니다. 그 중 `p_time` 변수는 게시글의 작성된 시간이 초단위까지 기록된 변수인데, 해당 변수를 활용해서 날짜, 요일과 같은 좀 더 세분화된 시간변수를 생성하도록 하겠습니다.   

```{r ,message=FALSE, cache=TRUE}
pxdata <- pxdata %>% mutate(p_ymd   = as.Date(p_time),                                        # 년-월-일 
                            p_month = as.factor(month(p_time)),                               # 월 
                            p_day   = as.factor(day(p_time)),                                 # 일 
                            p_hour  = as.factor(hour(p_time)),                                # 시간 
                            p_wday  = as.factor(lubridate::wday(as.Date(p_time), label = T))) # 요일

```

&nbsp;"프로듀스 X 101"은 매주 금요일 밤 11시에 시작하여 다음날 토요일 AM 12:30즈음 끝이 났었는데요. 데이터가 에피소드별로(매 주 방송되는 1주 간격으로) 어떻게 그리고 얼마나 변화했는지를 파악하기 위해 `lubridate`패키지의 `week()`함수를 사용하여 게시판의 글이 몇 화의 에피소드때 작성되었는지를 알리는 변수인 `p_episode` 변수를 생성하도록 하겠습니다. 매 화 방송이 끝나는 토요일부터 그 다음주 금요일까지의 기간을 하나의 에피소드 기간으로 취급하여 변수를 생성하였습니다.   

&nbsp;처음 데이터를 수집하기 시작한 날짜인 2019-06-01은 토요일로 전날 5화가 방영되던 날 이였습니다. 이 정보를 토대로 `p_episode` 변수를 생성하도록 하겠습니다.   

&nbsp;새로 생성된 시간과 관련된 변수들은 범주형 속성을 지니고 있으므로 `as.factor()`함수를 사용하여 범주형 값으로 변환했습니다.  

```{r, producex3_2}
pxdata <- pxdata %>% mutate(p_episode = week(p_ymd - 5) - 17) 
```
```{r}
pxdata %>% glimpse()
pxdata %>% summary()
is.na(pxdata) %>% colSums()
```
```{r, echo = FALSE}
pxdata %>% head(10) %>% kable() %>% kable_styling("striped") %>% scroll_box(width = "100%")
```

<br>
&nbsp;따로 저장되어 있던 데이터들을 하나로 묶고, 분석에 필요한 새로운 변수열을 생성하였습니다.   

&nbsp;마지막 에피소드는 `2019-07-19`에 방영 됐었습니다. 마지막 방송에서 진행된 시청자 문자투표는 방송이 시작한 시각인 밤 8시부터 밤 9시까지 진행이 됐었는데요. 투표가 종료된 이후의 데이터는 의미가 없으므로 데이터의 범위를 문자투표가 끝나는 시간인 `2019-07-19` 밤 9시까지로 설정하겠습니다.   
```{r}
# 일간별 데이터 갯수 확인 
table(pxdata$p_ymd)

# 마지막날 문자투표 종료 이후 데이터 삭제 
lastDay <- pxdata %>% 
    filter(p_ymd == '2019-07-19') %>% 
    filter(!p_hour %in% c(21, 22, 23, 24))

# 데이터 재 접합 
pxdata <- pxdata %>% 
    filter(p_ymd != '2019-07-19') %>% 
    rbind(lastDay)

# 데이터 확인 
table(pxdata$p_ymd)
```

&nbsp;마지막날의 데이터행이 124790개 에서 51546로 줄어든 것을 확인할 수 있습니다. 이것으로 전처리작업을 마치도록 하겠습니다.  
